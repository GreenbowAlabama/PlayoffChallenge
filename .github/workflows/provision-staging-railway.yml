name: Provision Railway Staging Environment

on:
  workflow_dispatch:

jobs:
  provision-staging:
    runs-on: ubuntu-latest

    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Debug token info
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "ERROR: RAILWAY_TOKEN is empty or not set"
            exit 1
          fi
          TOKEN_LENGTH=${#RAILWAY_TOKEN}
          echo "Token length: $TOKEN_LENGTH characters"
          echo "Token prefix: ${RAILWAY_TOKEN:0:4}..."
          echo "Token suffix: ...${RAILWAY_TOKEN: -4}"
          if [[ "$RAILWAY_TOKEN" =~ ^[a-f0-9-]+$ ]]; then
            echo "Token format: looks like UUID/hex format"
          else
            echo "Token format: contains non-hex characters"
          fi

      - name: Check Railway CLI version
        run: |
          railway --version

      - name: Test token via Railway API directly
        run: |
          echo "Testing token against Railway GraphQL API..."
          RESPONSE=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query": "{ me { name email } }"}')
          echo "API Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q "error"; then
            echo "API authentication failed"
          else
            echo "API authentication succeeded"
          fi

      - name: Verify Railway authentication
        run: |
          railway whoami

      - name: Create Railway project
        run: |
          PROJECT_ID=$(railway init -n playoff-challenge-staging -w "greenbowalabama's Projects" --json | jq -r '.id')
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
          echo "Created project: $PROJECT_ID"

      - name: Link to project
        run: |
          railway link -p "$PROJECT_ID"

      - name: Add Postgres database
        run: |
          railway add -d postgres
          echo "Postgres database added to project"

      # Phase 2 (service attachment) is handled separately
      # Services require explicit branch pinning which is not currently
      # supported by the Railway CLI. Services must be added manually
      # or via a future CLI update that supports branch selection.
