name: Provision Railway Staging Environment

on:
  workflow_dispatch:

# This workflow verifies Railway project token connectivity.
# Prerequisites (manual one-time setup):
#   1. Create project "playoff-challenge-staging" in Railway UI
#   2. Add PostgreSQL database to the project
#   3. Create a Project Token (Project Settings > Tokens)
#   4. Add token to GitHub as RAILWAY_TOKEN secret

jobs:
  verify-staging:
    runs-on: ubuntu-latest

    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          npm install -g @railway/cli

      - name: Debug token info
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "ERROR: RAILWAY_TOKEN is empty or not set"
            exit 1
          fi
          TOKEN_LENGTH=${#RAILWAY_TOKEN}
          echo "Token length: $TOKEN_LENGTH characters"
          echo "Token prefix: ${RAILWAY_TOKEN:0:4}..."
          echo "Token suffix: ...${RAILWAY_TOKEN: -4}"

      - name: Test Project Token via Railway API
        run: |
          echo "Testing project token against Railway GraphQL API..."
          RESPONSE=$(curl -s -X POST https://backboard.railway.com/graphql/v2 \
            -H "Project-Access-Token: $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query": "{ projectToken { projectId environmentId } }"}')
          echo "API Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q "projectId"; then
            echo "Project token authentication succeeded!"
            echo "PROJECT_ID=$(echo $RESPONSE | jq -r '.data.projectToken.projectId')" >> $GITHUB_ENV
            echo "ENVIRONMENT_ID=$(echo $RESPONSE | jq -r '.data.projectToken.environmentId')" >> $GITHUB_ENV
          else
            echo "Project token authentication failed"
            exit 1
          fi

      - name: Display project info
        run: |
          echo "Connected to Railway project!"
          echo "Project ID: $PROJECT_ID"
          echo "Environment ID: $ENVIRONMENT_ID"
          echo ""
          echo "Staging environment is ready for service deployment."
          echo "Next steps (Phase 2):"
          echo "  - Add services via Railway UI with branch pinning to 'staging'"
          echo "  - Configure environment variables"
