name: Provision Railway Staging Environment

on:
  workflow_dispatch:

jobs:
  provision-staging:
    runs-on: ubuntu-latest

    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Create Railway project
        run: |
          PROJECT_ID=$(railway init -n playoff-challenge-staging --json | jq -r '.id')
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV

      - name: Link to project
        run: |
          railway link -p "$PROJECT_ID"

      - name: Add Postgres database
        run: |
          railway add -d postgres

      - name: Add backend service (PlayoffChallenge)
        run: |
          railway add -s PlayoffChallenge -r "$GITHUB_REPOSITORY"

      - name: Add web-admin service (upbeat-analysis)
        run: |
          railway add -s upbeat-analysis -r "$GITHUB_REPOSITORY"

      - name: Generate ADMIN_JWT_SECRET
        run: |
          echo "ADMIN_JWT_SECRET=$(openssl rand -hex 32)" >> $GITHUB_ENV

      - name: Set backend environment variables
        run: |
          railway variables --set "NODE_ENV=staging" --set "ADMIN_JWT_SECRET=$ADMIN_JWT_SECRET" -s PlayoffChallenge

      - name: Set web-admin environment variables
        run: |
          railway variables --set "VITE_API_BASE_URL=https://playoffchallenge-staging.up.railway.app" -s upbeat-analysis
